name: Manual workflow

on:
  workflow_dispatch:
#  pull_request:
#    branches: [ $default-branch stable-* ]
#  push:
#    branches: [ $default-branch stable-* ]
#  schedule:
#    - cron:  '30 5 * * *'

jobs:
  cypress:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        repository: 'ansible/galaxy_ng'
        path: 'galaxy_ng'
    - working-directory: 'galaxy_ng'
      run: |
        cp .compose.env.example .compose.env
        ./compose build

    - uses: actions/checkout@v2
      with:
        path: 'ansible-hub-ui'
    - uses: actions/setup-node@v2
      with:
        node-version: '14'
    - working-directory: 'ansible-hub-ui'
      run: 'npm ci'
    - working-directory: 'ansible-hub-ui/test'
      run: |
        npm ci
        echo -e '{\n  "prefix": "/api/automation-hub/",\n  "username": "admin",\n  "password": "admin"\n}' > cypress.env.json

    - working-directory: 'galaxy_ng'
      run: |
        ./compose up -d postgres redis
        ./compose run --rm api manage migrate
        ./compose down

    - working-directory: 'galaxy_ng'
      run: ./compose up -d
    - working-directory: 'ansible-hub-ui'
      run: |
        # FIXME nowatch, or build-standalone+nginx?
        npm run start-standalone &
        cd test/
        sleep 2m
        npm run cypress:chrome
