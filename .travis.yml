language: node_js
sudo: required
notifications:
  email: false
  slack:
    rooms:
      - secure: juuizlfiQolXbqy4L2nfODB1K8xiSGvUrzsT3XeXIsQqX7yCYVvnRUssKLbqgLM9m85kgXJk1ef0qwjJoliNqGcrALTZLHPTkxWwTnV7tPEVS/4uQPSyy+DDHDwrTzCrF3qhCqyKJ6vB18z22qm3qLgStmNj4p1ZLznsdJR/u7U3spJ+WLL70QSNHCQy/5QjRDDiR3oqWdXjhVcUCeV+v/2CtfqK3dqYtzCL/b7z8lm/YbV6w1Rd8mwzTgLstbzjrvR/gq2IPALzzJTq1S8lXtV7ZtbYz4bjB8RNCRZFJrjBUH4CqD1oUskit4RRe+ilVs8qNQh0Tt3whsOdbJoRXJn2B/NVxppp2WGlODdsuMgfNh5iBocHKN3Qo4mONbstnHFG99Hr7L8GbUugJHEQlrZn1xRyO9ulyVp+hFp8/F088NNyhnd3+lERUPA5/4+HPQh6Ea+PyKq2TR41VoDGcRDBS4VY/6PfLEJzxEBjwRAAemfvtOFTUu2EocuAllPX1vMA4b1j7Wm+Bs7wft6nEcVdftVanfAgx4dNksnaS8zN9II8rdtBci2yXYJ6J+e+REDn/2IrHaUwr0N9BojYc0ePUElDcygW4Kk1oGklHp681j2zhi1Gt7rbuae1C9fD4QHnryx59uVH5NXqDsXI5EbwTJE3zvzRz9SzmyDqV5A=
node_js:
- '14'
install:
- npm ci
jobs:
  include:
  - stage: Deploy cloud.redhat.com
    script: npm run deploy && curl -sSL https://raw.githubusercontent.com/RedHatInsights/insights-frontend-builder-common/master/src/bootstrap.sh | bash -s
    if: tag IS blank
  - stage: Stable release
    if: tag IS NOT blank
    # Disable tests because cypress isn't currently configured to work in travis
    script: echo "npm test temporarily disabled"
    before_deploy:
      - npm run build-standalone
      - tar -C dist/ -czvf automation-hub-ui-dist.tar.gz .
    deploy:
      provider: releases
      file: automation-hub-ui-dist.tar.gz
      skip_cleanup: true
      api_key: $RH_GALAXY_DROID_GITHUB_TOKEN
      on:
        tags: true

  # Updates the "dev" github release whenever new changes are merged into master. This provides an up to date
  # tarball that https://github.com/ansible/galaxy_ng can use
  - stage: Dev release
    if: branch = master
    # Disable tests because cypress isn't currently configured to work in travis
    script: echo "npm test temporarily disabled"
    before_deploy:
      - git config --local user.name "Travis CI"
      - git config --local user.email "builds@travis-ci.com"
      - export TRAVIS_TAG=dev
      # update the dev tag
      - git tag -f $TRAVIS_TAG
      - git push -fq https://rh-galaxy-droid:$RH_GALAXY_DROID_GITHUB_TOKEN@github.com/ansible/ansible-hub-ui --tags
      - npm run build-standalone
      - tar -C dist/ -czvf automation-hub-ui-dist.tar.gz .
    deploy:
      provider: releases
      file: automation-hub-ui-dist.tar.gz
      overwrite: true
      skip_cleanup: true
      api_key: $RH_GALAXY_DROID_GITHUB_TOKEN
      on:
        branch: master

  - stage: Generate package manifest
    script: .travis/update_manifest.sh

env:
  global:
  - REPO="git@github.com:RedHatInsights/ansible-hub-ui-build.git"
  - REPO_DIR="ansible-hub-ui-build"
  - BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
  - NODE_OPTIONS="--max-old-space-size=4096 --max_old_space_size=4096"
